# ActiveRecord/ActiveQuery 重构计划

## 1. 背景

后端重构了"表达式-方言"系统，接管了构建 SQL 片段、参数元组的所有功能，因此 ActiveRecord/ActiveQuery 不再负责拼接 SQL，转而使用后端表达式-方言系统提供的现成功能。

## 2. 重构目标

1. ActiveQuery 保留简单查询和聚合查询功能并合二为一
2. 剥离 CTEQueryMixin，转而作为独立的 CTEQuery 类
3. ActiveQuery/CTEQuery 的查询接口支持字段代理发起的表达式类
4. 用方言协议替换能力声明系统
5. 提供静态类型检查支持（低优先级）

## 3. 重构内容

### 3.1 ActiveQuery 重构

- 保留简单查询和聚合查询功能
- 移除 SQL 拼接逻辑，转而使用表达式-方言系统
- 保持向后兼容性，继续接受字符串片段和元组列表
- 推荐使用字段代理发起的表达式类

### 3.2 CTEQuery 独立化

- 将 CTEQueryMixin 重构为独立的 CTEQuery 类
- CTEQuery 可以接收 ActiveQuery 作为子查询
- CTEQuery 与 ActiveRecord 解耦，专注于 CTE 相关功能

### 3.3 查询接口增强

- 扩展 where、having 等接口，支持字段代理表达式
- 保持对字符串片段和元组列表的支持（不推荐）
- 推荐使用字段代理发起的表达式类

### 3.4 方言协议替换能力声明

- 逐步将测试中的能力检查替换为协议检查
- 创建协议检查辅助函数
- 更新测试代码以使用协议而非能力声明
- 最终移除能力声明系统

### 3.5 静态类型检查（低优先级）

- 提供根据 ActiveRecord 类生成静态类型 pyi 文件的功能
- 用于 IDE 静态检查和代码提示

## 4. 实施步骤

### 4.1 第一阶段：ActiveQuery 与表达式-方言系统集成

1. 修改 ActiveQuery 类，移除 SQL 拼接逻辑
2. 集成表达式-方言系统，使用其构建 SQL 片段和参数
3. 保持向后兼容性，支持字符串片段和元组列表

### 4.2 第二阶段：CTEQuery 独立化

1. 创建独立的 CTEQuery 类
2. 将 CTE 相关功能从 ActiveQuery 中移出
3. 实现 CTEQuery 接收 ActiveQuery 作为子查询的功能

### 4.3 第三阶段：查询接口增强

1. 扩展查询接口，支持字段代理表达式
2. 添加对字段代理表达式的处理逻辑
3. 更新文档，推荐使用字段代理表达式

### 4.4 第四阶段：方言协议替换能力声明

1. 创建协议检查辅助函数
2. 逐步替换测试中的能力检查为协议检查
3. 更新测试装饰器和内部检查逻辑
4. 移除能力声明系统的相关代码

### 4.5 第五阶段：静态类型检查（可选）

1. 开发 pyi 文件生成工具
2. 根据 ActiveRecord 类定义生成静态类型文件
3. 集成到开发流程中

## 5. 注意事项

1. 确保向后兼容性
2. 充分测试重构后的功能
3. 更新相关文档和示例
4. 提供迁移指南
5. 逐步迁移测试系统，避免一次性大改动